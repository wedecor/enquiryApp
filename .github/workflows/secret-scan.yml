name: secret-scan
on: [push, pull_request]
permissions:
  security-events: write
  contents: read
jobs:
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install gitleaks
        run: |
          set -e

          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)

          case "$ARCH" in
            x86_64)  ARCH_TAG="x64" ;;
            aarch64|arm64) ARCH_TAG="arm64" ;;
            *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
          esac

          ASSET_URL=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest \
            | grep -oE "https://github.com/gitleaks/gitleaks/releases/download/.*/gitleaks_[0-9\\.]+_${OS}_${ARCH_TAG}\\.tar\\.gz" \
            | head -n1)

          if [ -z "$ASSET_URL" ]; then
            echo "‚ùå Could not find Gitleaks asset for ${OS}_${ARCH_TAG}"
            exit 2
          fi

          echo "‚¨áÔ∏è  Downloading $ASSET_URL"
          curl -sSL "$ASSET_URL" -o /tmp/gitleaks.tgz

          echo "üì¶  Extracting to /usr/local/bin"
          sudo tar -xzf /tmp/gitleaks.tgz -C /usr/local/bin gitleaks

          echo "‚úÖ  Installed version:"
          gitleaks version
      - name: Run gitleaks (SARIF)
        run: |
          gitleaks detect --source . --config .gitleaks.toml --report-format sarif --report-path gitleaks.sarif || true
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
      - name: Fail on findings
        run: |
          if grep -q '"results":\s*\[' gitleaks.sarif && ! grep -q '"results":\s*\[\s*\]' gitleaks.sarif; then
            echo "Secrets detected. See SARIF."; exit 1; fi
