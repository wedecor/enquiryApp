name: üõ°Ô∏è Security Audit

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Run weekly security audit
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

env:
  SECURITY_STRICT: ${{ github.ref == 'refs/heads/main' && '1' || '0' }}

jobs:
  gitleaks:
    name: üîç Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret detection

      - name: Run Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        with:
          args: detect --redact -v --exit-code=1 --report-format=sarif --report-path=results.sarif
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional for Pro features

      - name: Upload Gitleaks results
        if: always() && hashFiles('results.sarif') != ''
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.sarif

  security-audit:
    name: üõ°Ô∏è Repository Security Audit
    runs-on: ubuntu-latest
    needs: gitleaks  # Run after secret detection
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node 20 for Functions
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Guard FCM token location
        run: |
          if grep -R "collection('users').*fcmToken" lib/ || grep -R 'collection("users").*fcmToken' lib/; then
            echo "::error ::Write to users/{uid}.fcmToken detected. Move tokens to users/{uid}/private/notifications/tokens/{token}"
            exit 1
          fi
          if grep -R "collection('users').*webTokens" lib/ || grep -R 'collection("users").*webTokens' lib/; then
            echo "::error ::Write to users/{uid}.webTokens detected. Move tokens to users/{uid}/private/notifications/tokens/{token}"
            exit 1
          fi
          echo "‚úÖ No insecure FCM token storage detected"

      - name: Run security audit (strict on main)
        run: |
          npm run sec:all || true
          if [ "${{ env.SECURITY_STRICT }}" = "1" ]; then
            npm run sec:all
          fi

      - name: Run guard tests (Flutter)
        run: |
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs || true
          flutter test --machine || flutter test || true

      - name: Lint (errors only)
        run: flutter analyze || true

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: |
            security-audit-*.json
          retention-days: 30

  flutter-security:
    name: üîí Flutter Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Dependency status
        run: |
          dart pub outdated || true
          flutter pub outdated || true

  firestore-rules:
    name: üî• Firestore Rules Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Firestore rules checks
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: bash tool/ci/test_firestore_rules.sh

  summary:
    name: üìä Security Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, security-audit, flutter-security, firestore-rules]
    if: always()
    
    steps:
      - name: Security Audit Summary
        run: |
          echo "üõ°Ô∏è Security Audit Complete"
          echo "========================="
          echo "Gitleaks: ${{ needs.gitleaks.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Flutter Security: ${{ needs.flutter-security.result }}"
          echo "Firestore Rules: ${{ needs.firestore-rules.result }}"
          echo ""
          if [[ "${{ needs.gitleaks.result }}" == "failure" ]]; then
            echo "‚ùå CRITICAL: Secrets detected in repository (see earlier job)."
          fi
          if [[ "${{ needs.security-audit.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è Repository security audit reported issues. Review logs."
          fi
          if [[ "${{ needs.flutter-security.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è Flutter security job reported issues."
          fi
          if [[ "${{ needs.firestore-rules.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è Firestore rules validation reported issues."
          fi
          echo "‚úÖ Summary generated."
