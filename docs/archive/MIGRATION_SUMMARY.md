# Migration Summary: `active` → `isActive` Standardization

## Files Changed

### ✅ Flutter/Dart Files (8 files)

1. **`lib/features/admin/users/domain/user_model.dart`**
   - Field renamed: `active` → `isActive`
   - `fromFirestore()`: Reads both fields (backward compatible)
   - `toFirestore()`: Writes only `isActive`

2. **`lib/features/admin/users/domain/user_model.g.dart`** *(Auto-generated)*
   - Will be regenerated by `build_runner`

3. **`lib/features/admin/users/domain/user_model.freezed.dart`** *(Auto-generated)*
   - Will be regenerated by `build_runner`

4. **`lib/features/admin/users/data/users_repository.dart`**
   - Query: `where('active')` → `where('isActive')`
   - `toggleActive()`: Writes `isActive`

5. **`lib/core/services/notification_service.dart`**
   - `_getAdminUsers()`: Reads both fields (backward compatible)
   - Debug logging updated

6. **`lib/core/services/firestore_service.dart`**
   - `createUser()`: Writes `isActive` (already was, added comment)

7. **`lib/features/admin/users/presentation/user_management_screen.dart`**
   - All `user.active` → `user.isActive` (8 occurrences)

8. **`lib/features/admin/users/presentation/widgets/user_form_dialog.dart`**
   - `widget.user!.active` → `widget.user!.isActive`

### ✅ Cloud Functions/TypeScript Files (2 files)

1. **`functions/src/index.ts`**
   - `isAdmin()`: Checks both fields (backward compatible)
   - `inviteUser()`: Sets `isActive: true`

2. **`functions/src/notifyOverdueInTalks.ts`**
   - `fetchAdminProfiles()`: Filters by both fields in memory (backward compatible)

### ✅ Migration Scripts (2 new files)

1. **`scripts/migrate-active-to-isactive.ts`**
   - Migrates Firestore documents: `active` → `isActive`
   - Supports dry-run mode
   - Batch processing

2. **`scripts/rollback-isactive-to-active.ts`**
   - Rolls back migration if needed
   - Copies `isActive` → `active` and removes `isActive`

### ✅ Documentation (1 new file)

1. **`MIGRATION_GUIDE_ACTIVE_TO_ISACTIVE.md`**
   - Complete migration guide
   - Step-by-step instructions
   - Rollback procedures

## Action Required

### Before Migration

1. **Regenerate Code**:
   ```bash
   flutter pub run build_runner build --delete-conflicting-outputs
   ```

2. **Test Locally**:
   - Verify user management works
   - Test notifications
   - Test user creation/editing

### Migration Execution

1. **Deploy Code**:
   ```bash
   cd functions && npm run build && firebase deploy --only functions
   ```

2. **Run Migration** (dry-run first):
   ```bash
   npx ts-node scripts/migrate-active-to-isactive.ts --dry-run
   npx ts-node scripts/migrate-active-to-isactive.ts
   ```

### After Migration

1. **Verify**:
   - Check Firestore console
   - Test notifications
   - Monitor Cloud Functions logs

2. **Optional Cleanup** (after 1-2 weeks):
   - Remove `active` field from documents (separate script)

## Backward Compatibility

✅ **Code is backward compatible**:
- Reads both `active` and `isActive` fields
- Prefers `isActive` if both exist
- Writes only `isActive`

✅ **Migration is safe**:
- No downtime required
- Can be done gradually
- Rollback available

## Rollback Strategy

If issues occur:

1. Run rollback script: `npx ts-node scripts/rollback-isactive-to-active.ts`
2. Revert code changes: `git revert <commit>`
3. Redeploy: `firebase deploy --only functions`

## Notes

- **Dropdown items** still use `active` field (different entity, no change needed)
- **Firestore indexes** for dropdowns remain unchanged (they use `active` for dropdown items, not users)
- **User queries** will use `isActive` index (may need to create new index if not exists)

